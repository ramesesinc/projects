<workunit extends="wtemplates/SimpleReportController.xml" >
    <invokers>
       <invoker type="business_permit:print" index="50" action="printReport"/>    
       <invoker type="business_permit:open" index="50" action="openReport" target="window"/>    
       
       <invoker type="formActions" caption="Back" action="_close" mnemonic="b" shortcut="ctrl B" /> 
       <invoker type="formActions" caption="Update Plate No" action="updatePlateno"  /> 
    </invokers>
    
    <code>
        <![CDATA[    
        import com.rameses.rcp.annotations.*
        import com.rameses.rcp.common.*
        import com.rameses.osiris2.client.*
        import com.rameses.osiris2.common.*
        import java.rmi.server.*;
        import java.text.SimpleDateFormat;
        import com.rameses.osiris2.reports.*;
        
        class  BusinessPermitReportController extends ReportController {
        
            @Service("BusinessPermitService") 
            def permitSvc
            
            def entity;
            def data = [:];
            def title = "Business Permit"

            String reportpath = "com/rameses/gov/etracs/bpls/reports/permit/"
            String reportName = reportpath + "BusinessPermit.jasper";
                        
            @FormId
            def formId
            
            @FormTitle
            def formTitle
            
            def applicationid;
            
            def getReportData(){
                data = permitSvc.getReport( [applicationid: applicationid] );
                if(data.photo) {
                    try {
                        data.photo = new java.io.ByteArrayInputStream( data.photo );
                    } catch(e) {
                        data.photo = null;
                    }    
                }
                return data;
            }
            
            def printReport() {
                applicationid = entity.objid;
                return preview(); 
            } 
            
            def openReport() {
                formTitle = entity.permitno;
                formId = entity.objid;
                applicationid = entity.applicationid;
                preview(); 
            } 

            SubReport[] getSubReports(){ 
                return [
                    new SubReport("BusinessPermitLOB", reportpath + "BusinessPermitLOB.jasper"),
                    new SubReport("BusinessPermitOR", reportpath + "BusinessPermitPayment.jasper")
                ] as SubReport[]
            }
            
            def updatePlateno() {
                def p = MsgBox.prompt( 'Enter updated Plate No:' );
                if(!p) return;
                
                def permitid = entity.permit?.objid; 
                if ( !permitid ) permitid = entity.objid;
                
                permitSvc.updatePlateno([objid: permitid, plateno: p]);
                preview();
            }
         }   
        ]]>
    </code>
</workunit>