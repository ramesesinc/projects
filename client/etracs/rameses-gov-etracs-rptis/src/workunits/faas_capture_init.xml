<?xml version="1.0" encoding="UTF-8"?>
<workunit>
    <invokers>
         <invoker type="quick_launcher" code="DC01" action="init"  caption="Data Capture" index="1" role="ENCODER" />
         <invoker folderid="/explorer/txn/rpt/manual" action="init"  caption="Data Capture" index="1" newrpu="true" newrealproperty="true"  role="ENCODER" />         
         <invoker type="formActions" action="_close" caption="Close" mnemonic="c" icon="images/toolbars/cancel.png" immediate="true" />
         <invoker type="formActions" action="process" caption="Next" mnemonic="n" icon="images/toolbars/arrow_right.png" />
    </invokers>
        
<code>
<![CDATA[

import com.rameses.rcp.annotations.* 
import com.rameses.rcp.common.* 
import com.rameses.osiris2.client.*
import com.rameses.osiris2.common.*
import com.rameses.gov.etracs.rpt.util.*;

class FaasDataCaptureInitController
{
    @Binding
    def binding;
    
    @Service('FAASService')
    def svc;
    
    @Service('RPUService')
    def rpuSvc;
    
    @Service('LGUService')
    def lguSvc;
    
    @Service('Var')
    def var;
    
    
    String title = 'Data Capture FAAS Initial Information';
    
    def entity = [:]
    
    def pinTypes = ['new', 'old']
    def rpuTypes;
    def txnTypes;
    
    
    @PropertyChangeListener
    def listener = [
        'entity.rputype' : {
            entity.barangay = null;
            entity.rp = null;
            entity.suffix = null;
            if (entity.rputype == 'land')
                entity.suffix = 0
            entity.isection = null;
            entity.iparcel = null;
            
        },
        
        'entity.pintype' :{
            entity.isection = null;
            entity.iparcel = null;
            binding.refresh('entity.(isection|iparcel)');
        },
        
        'entity.*' : { buildPin(); }
    ]
    
                
    void init(){
        entity.ry = var.get('current_ry');
        entity.rputype = 'land';
        entity.suffix = 0;
        entity.datacapture = true;
        rpuTypes = rpuSvc.getRpuTypes();
        txnTypes = svc.getTxnTypes();
        
        entity.pintype = var.get('pin_type');
        if (!entity.pintype)
            entity.pintype = 'new';
    }
    
    
    def process(){
        def faas = svc.initCaptureAndCreate(entity);
        faas.lgu = entity.lgu;
        faas.prevpin = entity.fullpin;
        def filetype = 'faas:capture:create'
        
        entity.rputype = null;
        entity.isection = null;
        entity.iparcel = null;
        entity.claimno = null;
        
        return InvokerUtil.lookupOpener(filetype, [entity:faas])
    }
    
    
    def getLookupBarangay(){
        return InvokerUtil.lookupOpener('barangay:lookup', [
            onselect: { 
                entity.barangay = lguSvc.lookupBarangayById(it.objid);
                entity.lgu = entity.barangay.lgu;
                entity.rp = null;
                buildPin();
            },
            onempty : { entity.barangay = null },
        ])
    }
    
    
    def getLookupRealProperty(){
        return InvokerUtil.lookupOpener('realproperty:lookup', [
            onselect: { 
                entity.rp = it; 
                entity.barangay = lguSvc.lookupBarangayById(it.barangayid);
                entity.lgu = entity.barangay.lgu 
                entity.isection = RPTUtil.toInteger(entity.rp.section);
                entity.iparcel = RPTUtil.toInteger(entity.rp.parcel);
                buildPin();
            },
            onempty : { entity.rp = null; },
        ])
    }
    
    void buildPin(){
        RPTUtil.buildPin(entity, var);
        binding?.refresh('entity.pin');
    }
    

    def getLgus(){
        return lguSvc.getLgus();
    }

    def getBarangays(){
        if (! entity.lgu)
            return [];
        return lguSvc.lookupBarangaysByRootId(entity.lgu?.objid);
    }

}

]]>
</code>

<pages>
    <page template="com.rameses.gov.etracs.rpt.faas.ui.FaasInitPage"/>
</pages>
</workunit>


