<?xml version="1.0" encoding="UTF-8"?>
<workunit extends="rpt_wtemplates/FAASTxnInitController.xml">
    <invokers>       
        <invoker type="quick_launcher" code="ND01" action="init" caption="New Discovery" 
            txntype="ND" role="APPRAISER,EXAMINER,RECEIVER" permission="faas.createNewDiscovery" index="0"/>
            
        <invoker folderid="/explorer/txn/rpt/online" action="init" caption="New Discovery" 
            txntype="ND" role="APPRAISER,EXAMINER,RECEIVER" permission="faas.createNewDiscovery" index="0"  />
            
        <invoker folderid="/home/rpt/txn" action="init" caption="New Discovery" 
            txntype="ND" role="APPRAISER,EXAMINER,RECEIVER" permission="faas.createNewDiscovery" index="0"  />
    </invokers>
    <code>
        

import com.rameses.rcp.annotations.* 
import com.rameses.rcp.common.* 
import com.rameses.osiris2.client.*
import com.rameses.osiris2.common.*
import com.rameses.gov.etracs.rpt.util.RPTUtil;


class FaasNDInitController extends com.rameses.gov.etracs.rpt.faas.ui.FaasTxnInitController
{
    @Service('BarangayLookupService')
    def brgySvc;
    
    @Service('RealPropertyService')
    def rpSvc;
    
    @Service('RPUService')
    def rpuSvc;
    
    @Service('LGUService')
    def lguSvc;
        
    @Service('Var')
    def var; 
        
    @Service('FAASService')
    def faasSvc;
        
    
    def pinTypes = ['new', 'old']
    def rpuTypes;
    
    @PropertyChangeListener
    def listener = [
        'entity.rputype' : {
            entity.barangay = null;
            entity.suffix = null;
            if (entity.rputype == 'land')
                entity.suffix = 0
            entity.isection = null;
            entity.iparcel = null;
        },
        
        'entity.pintype' :{
            entity.isection = null;
            entity.iparcel = null;
        },
        
        'entity.*' : { buildPin(); }
    ]
    
                
    void afterInit(){
        entity.ry = var.get('current_ry');
        entity.rputype = 'land';
        entity.suffix = 0;
        rpuTypes = rpuSvc.getRpuTypes();
        entity.attributes = faasSvc.getTxnTypeAttributes([objid:'ND'])
    }
    
    def getLookupBarangay(){
        return InvokerUtil.lookupOpener('barangay:lookup', [
            onselect: { 
                entity.barangay = it;
                entity.rp = null;
                buildPin();
            },
            onempty : { entity.barangay = null },
        ])
    }
    
    
    def getLookupRealProperty(){
        return InvokerUtil.lookupOpener('realproperty:lookup', [
            onselect: { 
                if (it.state == 'CANCELLED')
                    throw new Exception('Cancelled Property is not allowed.');
                entity.rp = it; 
                entity.barangay = brgySvc.getById(entity.rp.barangayid);
                entity.barangayid = entity.barangay.objid;
                entity.isection = RPTUtil.toInteger(entity.rp.section);
                entity.iparcel = RPTUtil.toInteger(entity.rp.parcel);
                buildPin();
            },
            onempty : { entity.rp = null; },
        ])
    }
    
    void buildPin(){
        RPTUtil.buildPin(entity, var);
        binding?.refresh('entity.pin');
    }
    
    def process(){
        entity.txntype = [objid:'ND'];
        def faas = svc.initNewDiscovery(entity);
        faas.lgu = entity.lgu 
        return InvokerUtil.lookupOpener('faas:open', [entity:faas]);
    }
    
    
    def getLgus(){
        return lguSvc.getLgus();
    }

    def getBarangays(){
        return lguSvc.lookupBarangaysByRootId(entity.lgu?.objid);
    }
        
    def listHandler = [
        fetchList : { return entity.attributes }
    ] as EditorListModel;
             
    
}

    </code>
    
    <pages>
        <page template="com.rameses.gov.etracs.rpt.faas.ui.FaasPINInitPage"/>
    </pages>    
</workunit>


