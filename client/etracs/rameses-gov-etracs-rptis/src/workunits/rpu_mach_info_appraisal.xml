<?xml version="1.0" encoding="UTF-8"?>
<workunit>
    <invokers>
        <invoker type="rpumach:info" action="init" caption="Property Appraisal" index="5" mnemonic="A"/>
    </invokers>
    
    <code>
<![CDATA[        
        
import com.rameses.rcp.annotations.* 
import com.rameses.rcp.common.* 
import com.rameses.osiris2.client.* 
import com.rameses.osiris2.common.* 
import com.rameses.gov.etracs.rpt.util.RPTUtil;

class MachAppraisalInfoController extends com.rameses.gov.etracs.rpt.workflow.BasicInfoController
{
    
    @Service('MachRPUService')
    def svc;
    
    def rpuSvc;
    
    void init(){
        entity.rpu.dtappraised = entity.appraiser?.dtsigned;
    }
    
    void calculateAssessment(){
        super.calculateAssessment();
        machineListHandler.load();
    }
    
    
    /*------------------------------------------------------
     *
     * MACHINE APPRAISAL SUPPORT
     *
     ------------------------------------------------------*/
    def actualuse;
    def selectedMachine;
    
    List getMachuses(){
        return entity.rpu.machuses;
    }
    
    def machineListHandler = [
        getRows   : { return 25 },
        fetchList : { return actualuse?.machines },
                
        onRemoveItem : { item ->
            if (! allowEdit ) return false;
            if (MsgBox.confirm('Remove selected item?')){
                actualuse.machines.remove(item);
                if (!entity.rpu._machines) entity.rpu._machines = [];
                entity.rpu._machines.add(item);
                calculateAssessment();
                return true;
            }
            return false;
        }
    ] as EditorListModel
     
            
    def onaddMachine = {
        actualuse.machines.add(it);
        calculateAssessment();
    }
                
    def addMachine(){
        if (!actualuse) return;
        return InvokerUtil.lookupOpener('machdetail:create', [ 
            svc     : svc,
            rpu     : entity.rpu,
            machuse : actualuse,
            onadd   : onaddMachine,
        ])
    }
    
        
    def onupdateMachine = {
        calculateAssessment();
    }
    
    
    def editMachine(){
        return InvokerUtil.lookupOpener('machdetail:open', [ 
            svc         : svc,
            rpu         : entity.rpu,
            machuse     : actualuse,
            machdetail  : selectedMachine, 
            onupdate    : onupdateMachine,
            allowEdit   : allowEdit,
        ])
    }
    
    
    def getLookupFaas(){
        return Inv.lookupOpener('bldgmaster:lookup', [
            ry       : entity.rpu.ry, 
            pin      : entity.rp.pin, 
            rputype  : 'bldg',
            
            onselect : {
                entity.rpu.bldgmaster = it;
            },
            
            onempty  : {
                entity.rpu.bldgmaster = null;
            }

        ])
    }
    
    
}    
    
]]>        
    </code>
    
    <pages>
        <page template="com.rameses.gov.etracs.rpt.rpu.mach.ui.RpuMachInfoAppraisalPage"/>
    </pages>
</workunit>
