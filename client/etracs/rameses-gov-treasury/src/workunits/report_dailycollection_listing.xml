<workunit>
    <invokers>
        <invoker folderid="/explorer/report/treasury" caption="Daily Report Of Collection" target="window" index="10">
            <action name="doInit" role="REPORT" tag="all" permission="collectionreport.view"/> 
            <action name="doInit" role="COLLECTOR" tag="collector" permission="collectionreport.view"/> 
        </invoker> 
        
        <invoker type="formActions" action="_close" caption="Cancel" mnemonic="c"  icon="images/toolbars/cancel.png" immediate="true" visibleWhen="#{mode=='init'}"/>
        <invoker type="formActions" action="print" caption="Print" mnemonic="p" shortcut="ctrl + P" visibleWhen="#{mode=='init'}"/>
        <invoker type="formActions" action="preview" caption="Preview" mnemonic="v"   visibleWhen="#{mode=='init'}"/>
        <invoker type="formActions" action="_close" caption="Close" mnemonic="c"  icon="images/toolbars/cancel.png" immediate="true" visibleWhen="#{mode=='view'}"/>
        <invoker type="formActions" action="back" caption="Back" mnemonic="c"  immediate="true" visibleWhen="#{mode=='view'}"/> 
    </invokers>
    
    <code>
<![CDATA[
import com.rameses.rcp.common.*;
import com.rameses.rcp.annotations.*;
import com.rameses.osiris2.client.*;
import com.rameses.osiris2.reports.*;
import com.rameses.rcp.framework.ClientContext;

class DailyReportCollectionListingController extends com.rameses.etracs.shared.ReportController {

    @Service('CollectionReportService') 
    def svc;
    
    @Script('User')
    def user;
        
    String title = 'Daily Report Of Collection Listing';
    String reportpath = 'com/rameses/gov/treasury/report/';
    String reportName = reportpath + 'report_dailycollection_listing.jasper' 

    def tag;
    def months;
    def acctgroups;
    def data;

    def periods = [
        [type:'monthly', title:'Monthly'],
        [type:'daily', title:'Daily']
    ];

    void doInit( invoker ) {
        init();
        
        tag = invoker?.properties?.tag; 
        def options = svc.getReportOptions([:]);
        months = options.months; 
        entity.period = periods[1].type; 
        entity.collector = [
            objid : user.env.USERID,
            name  : user.env.FULLNAME 
        ]; 
    } 
    
    def getReportData(){
        data = svc.getReportListing( entity ); 
        return data.reportdata; 
    }

    Map getParameters(){ 
        return data.header;
    }
    
    SubReport[] getSubReports() {
        return [ 
            new SubReport("ListingItem", reportpath + "report_dailycollection_listingitem.jasper"),
        ] as SubReport[]; 
    } 
    
    def lookupCollector = Inv.lookupOpener('collector:lookup', [
        onselect: { o-> 
            def name = [o.firstname, o.middlename, o.lastname].findAll{(it? true: false)}.join(' '); 
            entity.collector = [objid: o.objid, name: name]; 
        }, 
        onempty: {
            entity.collector = null; 
        } 
    ]); 
}
]]>        

    </code>
    
    <pages>
        <page template="com.rameses.gov.treasury.report.view.CollectionReportCriteriaPage" />
        <page name="preview" template="com.rameses.osiris2.common.ui.ReportPreviewPage"/>
    </pages>      
</workunit>