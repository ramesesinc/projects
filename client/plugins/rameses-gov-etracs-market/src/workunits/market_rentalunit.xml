<workunit>
    <invokers>
        <invoker type="market_rentalunit:create" caption="New Market Rental Unit" index="4" action="create"/>
        <invoker type="market_rentalunit:open" caption="View Market Rental Unit" index="4" action="open"/>
    </invokers>
    <code>
         <![CDATA[
            import com.rameses.rcp.common.*
            import com.rameses.rcp.annotations.*
            import com.rameses.osiris2.client.*
            import com.rameses.osiris2.common.*
            import java.rmi.server.*
            
            class MarketRentalUnitController extends CRUDController {
            
                @Service("MarketRentalUnitService")
                def service;
            
                @Caller
                def caller;
                
                @Binding
                def binding;
                
                def unitTypes;
                def market;
                def selectedAttribute;
                
                String entityName  = 'market_rentalunit'
                String prefixId    = 'MRU';
                
                void onInit() {
                    market = caller.market;
                    if(!market)
                        throw new Exception("Please select a market from the query");
                    unitTypes = LOV.MARKET_UNIT_TYPES*.key
                }
                
                Map createEntity() {
                    def m = [ attributes:[] ];
                    m.marketid = market.objid;
                    return m;
                }
            
                def getLookupBuilding() {
                    return Inv.lookupOpener( "market_building:lookup", ['query.marketid': market.objid]);
                }
                
                def attrModel = [
                    fetchList: { o->
                        return entity.attributes;
                    }
                ] as BasicListModel;
                
                def addAttribute() {
                    def s = { o->
                        if( entity.attributes.find{ it.attribute.objid==o.objid} )
                            throw new Exception("Attribute already added");
                        def m = [attribute: o];
                        m.objid = "MUATTR"+new UID();
                        m.parentid = entity.objid;
                        service.addAttribute( m );
                        entity.attributes << m;
                        attrModel.reload();
                    }
                    return Inv.lookupOpener( "marketattribute:lookup", [onselect: s]);
                }
                
                def removeAttribute() {
                    if(!selectedAttribute) return;
                    entity.attributes.remove(selectedAttribute);
                    service.removeAttribute( selectedAttribute );
                    attrModel.reload();
                }

            }
            ]]>
    </code>
    <pages>
        <page template="com.rameses.gov.etracs.market.MarketRentalUnit"/>
    </pages>
</workunit>