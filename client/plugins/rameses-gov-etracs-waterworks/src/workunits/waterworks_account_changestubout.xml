<workunit schemaName="waterworks_account">
    <invokers>
        <invoker type="waterworks_account:form:menuActions" 
                 caption="Change Stubout" 
                 target="popup"
                 action="init"
                 visibleWhen="#{mode=='read'}"
                />   
    </invokers> 
    
    <code>
    <![CDATA[ 
import com.rameses.rcp.annotations.*;
import com.rameses.rcp.common.*;
import com.rameses.osiris2.client.*;
import com.rameses.osiris2.common.*;

class ChangeAccountStuboutModel extends com.rameses.seti2.models.ChangeInfoModel {

    @Binding 
    def binding; 

    def data = [:];

    public def init() { 
        schema = caller.schema;
        entity = caller.entity;
        fields = 'stuboutnode,stubout';
        data   = [:];
        handler = { o->
            caller.loadData();
            info.stubout = caller.entity.stubout;
            info.stuboutnode = caller.entity.stuboutnode;
        }
        return super.init();
    } 

    def getLookupStubout() {
        def params = [:]; 
        params.onselect = { o-> 
            data.clear(); 
            data.stubout = o; 
            info.stubout = [ objid: o.objid ]; 
            binding.refresh(); 
        } 
        params.onempty = { 
            data.clear();
            info.stubout = null;
            info.stuboutnode = null;
            binding.refresh();
        } 
        return Inv.lookupOpener("waterworks_stubout:lookup", params); 
    } 
    
    def getLookupStuboutnode() { 
        def params = [stuboutid: info.stubout?.objid]; 
        params.onselect = { o-> 
            if ( o.account?.objid || o.acctid ) 
                throw new Exception("There is already an account assigned. Choose another"); 
            
            data.stuboutnode = o; 
            info.stuboutnode = [ objid: o.objid ]; 
            binding.refresh(); 
        } 
        params.onempty = { 
            data.stuboutnode = null; 
            info.stuboutnode = null; 
            binding.refresh(); 
        } 
        return Inv.lookupOpener("waterworks_stubout_node_unassigned_account:lookup", params); 
    } 
} 
    ]]> 
    </code> 
    
    <pages>
        <page template="com.rameses.gov.etracs.waterworks.views.ChangeAccountStuboutPage"/>
    </pages>
</workunit>