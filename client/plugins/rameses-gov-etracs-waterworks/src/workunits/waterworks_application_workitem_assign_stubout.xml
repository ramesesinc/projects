<workunit>
    <invokers>
        <invoker type="waterworks_application:form:formActions" 
                 visibleWhen="#{task.state=='for-assessment' 
                    &amp;&amp; task.assignee?.objid!=null}"
                 caption="Specify Stubout"
                 target="process"
                 action="assignStubout"
                 />
                 
        <invoker type="waterworks_application:form:formActions" 
                 visibleWhen="#{task.state=='for-assessment' 
                    &amp;&amp; task.assignee?.objid!=null
                    &amp;&amp; entity.stubout?.code != null }"
                 caption="Change Stubout Position"
                 target="process"
                 action="changeStuboutPosition"
                 />
                 
    </invokers>
    <code>
        <![CDATA[
        
        import com.rameses.rcp.common.*;
        import com.rameses.rcp.annotations.*;
        import com.rameses.osiris2.client.*;
        import com.rameses.osiris2.common.*;
        import com.rameses.common.*;
        import com.rameses.util.*;
        
        class AssignStubout {
        
            @Service("PersistenceService")
            def persistenceSvc;

            @Caller
            def caller;

            String schemaName = "waterworks_application";

            def getEntity() {
                return caller.entity;
            }

            void assignStubout() {
                def h = { o->
                    persistenceSvc.update( [objid:entity.objid, stubout: o, _schemaname: schemaName] ); 
                    entity.stubout = o;
                    caller.refresh();
                }
                Modal.show( "waterworks_stubout:lookup", [onselect: h] ); 
            }

            def changeStuboutPosition() {
                if( !entity.stubout?.objid ) throw new Exception("Specify stubout first");
                def p = MsgBox.prompt("Enter stubout position" );
                if(p) {
                    persistenceSvc.update( [objid:entity.objid, stuboutindex: p.toInteger(), _schemaname: schemaName ] ); 
                    entity.stuboutindex = p;
                    caller.refresh();
                }
            }
                                    
        }
        
        ]]>
    </code>
  
</workunit>
