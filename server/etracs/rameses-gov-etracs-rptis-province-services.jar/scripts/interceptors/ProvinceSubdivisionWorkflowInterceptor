import com.rameses.annotations.*
import com.rameses.common.*;
import com.rameses.services.extended.*;

class ProvinceSubdivisionWorkflowInterceptor
{
	@Env
	def env 

	@Service('RPTCloudNotificationService')
	def svc

	@Service('SubdivisionSupportService')
	def supportSvc 

	@ActiveDB('subdivision_task')
	def taskEm;
	

	@After(pattern="SubdivisionService.resendToMunicipality") 
	public void resendToLguOnlineConsolidation( evt ) {
		println 'Resend subdivision to municipality...'
		def subdivision = evt.result
		doNotifyMunicipality(subdivision)
	}	

	@After(pattern="SubdivisionWorkflowService.signal", eval="#{args[0].state.matches('approver|provapprover') && args[0].action == 'completed' }") 
	public void submitToLguOnlineSubdivision( evt ) {
		println 'submitToLguOnlineSubdivision...'
		def subdivision = evt.args[0].data;
		doNotifyMunicipality(subdivision)
	}

	void doNotifyMunicipality(subdivision){
		if (isSubdivisionFromProvince(subdivision)){
			//post province created subdivision to municipality
			postSubdivisionToMunicipality(subdivision)
		}
		else {
			// notify municipality of the approve subdivision
			notifyMunicipality(subdivision)
		}
	}

	void notifyMunicipality(subdivision){
		println 'Notify municipality....'
		subdivision.tasks = taskEm.getTasks(subdivision)
		supportSvc.buildFaasesData(subdivision)
		def asyncreq = svc.createAsyncRequest('MunicipalitySubdivisionRemoteCallHandler', 'approveSubdivisionByProvince',  subdivision)
		def msg = svc.createAsyncMessage(asyncreq[0], subdivision.lguid)
		msg.filetype = 'subdivision'
		msg.messagetype = 'subdivision-prov-approved'
		msg.txnid = subdivision.objid 
		msg.txnno = subdivision.txnno 
		svc.sendMessage(msg)
	}

	void postSubdivisionToMunicipality(subdivision){
		println 'Post subdivision to municipality....'
		def data = supportSvc.buildSubdivisionData(subdivision)
		def asyncreq = svc.createAsyncRequest('MunicipalitySubdivisionRemoteCallHandler', 'postApprovedSubdivisionFromProvince',  data)
		def msg = svc.createAsyncMessage(asyncreq[0], subdivision.lguid)
		msg.filetype = 'subdivision'
		msg.messagetype = 'subdivision-prov-created'
		msg.txnid = subdivision.objid 
		msg.txnno = subdivision.txnno 
		svc.sendMessage(msg)
	}

	def isSubdivisionFromProvince(subdivision){
		return subdivision.originlguid.replaceAll('-.*?','') == env.ORGID.replaceAll('-.*?', '')
	}

}
