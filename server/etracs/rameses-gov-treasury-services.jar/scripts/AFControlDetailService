import com.rameses.annotations.*;
import com.rameses.util.*;

class AFControlDetailService  {

	@DataContext("af_control_detail")
	def afControlDetail;

	@ProxyMethod
	public void addDetail( def ref, def options, def controlid, def txndate, def startseries, def endseries, def txntype, def remarks ) {

		def mm = [:];  
		mm.parent = [objid: controlid];
		mm.txndate = txndate;
		mm.refno = ref.refno;
		mm.refid = ref.refid;
		mm.refdate = ref.refdate;
		mm.reftype = ref.reftype;
		mm.txntype = txntype;
		mm.indexno = 1;
		mm.remarks = remarks;
		if( ref.respcenter ) mm.respcenter = ref.respcenter;
		if( ref.issueto ) mm.issueto = ref.issueto;

		mm.state = 0;

		int qty = (Integer.parseInt( endseries +'')-Integer.parseInt( startseries+'' )) + 1;  

		if( txntype == "received" ) {
			mm.receivedstartseries = startseries;
			mm.receivedendseries =  endseries;
			mm.qtyreceived = qty;
		}
		else {
			mm.receivedstartseries = 0;
			mm.receivedendseries =  0;
			mm.qtyreceived = 0;
		}

		if( txntype == "begin") {
			mm.beginstartseries = startseries;
			mm.beginendseries =  endseries;
			mm.qtybegin = qty;
		}
		else {
			mm.beginstartseries = 0; 
			mm.beginendseries = 0; 
			mm.qtybegin  = 0;
		}

		if( txntype == "issue" ) {
			mm.issuedstartseries = startseries;
			mm.issuedendseries = endseries;
			mm.qtyissued  = qty;
		}
		else {
			mm.issuedstartseries = 0;
			mm.issuedendseries = 0;
			mm.qtyissued  = 0;
		}


		if(options?.endingstartseries) {
			mm.endingstartseries = options.endingstartseries;
			mm.endingendseries = options.endingendseries;
			mm.qtyending  = (Integer.parseInt( mm.endingendseries +'')-Integer.parseInt( mm.endingstartseries +'' )) + 1; ;
		}
		else {
			mm.endingstartseries = startseries;
			mm.endingendseries = endseries;
			mm.qtyending  = qty;
		}

		if(options?.qtycancelled) {
			mm.qtycancelled = options.qtycancelled;
		}
		else {
			mm.qtycancelled  = 0;	
		}
		afControlDetail.create( mm );
	}

	


}
