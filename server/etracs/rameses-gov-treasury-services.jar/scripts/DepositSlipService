import com.rameses.annotations.*;
import com.rameses.util.*;
import java.rmi.server.*;

class DepositSlipService  {

	@DataContext("depositslip")
	def depositSlipEm;

	@DataContext("paymentcheck")
	def paymentCheckEm;

	@ProxyMethod
	public def updateCheckTotal( def o ) {
		if(!o.items) throw new Exception( "items is required");
		if(!o.depositslipid) throw new Exception( "depositslipid is required");
		o.items.each {
			paymentCheckEm.find([ objid:it.objid ]).update( [depositslipid: o.depositslipid ] );
		}
		def z = [ depositslipid: o.depositslipid ];
		depositSlipEm.updateCheckTotal( z );
		depositSlipEm.cleanUpNullTotals( z );
		def c = depositSlipEm.find( [objid: o.depositslipid ]).first();
		depositSlipEm.updateFundCheckTotals( [ depositvoucherid: c.depositvoucherid , fundid: c.fundid ] );
		return c;
	}

	@ProxyMethod
	public def removeCheck( def o ) {
		if(!o.items) throw new Exception( "items is required");
		if(!o.depositslipid) throw new Exception( "depositslipid is required");
		o.items.each {
			paymentCheckEm.find([ objid:it.objid ]).update( [depositslipid: "{NULL}" ] );
		}
		def z = [ depositslipid: o.depositslipid ];
		depositSlipEm.updateCheckTotal( z );
		depositSlipEm.cleanUpNullTotals( z );
		def c = depositSlipEm.find( [objid: o.depositslipid ]).first();
		depositSlipEm.updateFundCheckTotals( [ depositvoucherid: c.depositvoucherid , fundid: c.fundid ] );
		return c;
	}

	@ProxyMethod
	public void updateCash( def o ) {
		if(!o.depositslipid) throw new Exception( "depositslipid is required");
		if(!o.containsKey('totalcash')) throw new Exception( "totalcash is required");
		def u =  [totalcash: o.totalcash ] ; 
		if ( o.cashbreakdown ) u.cashbreakdown = o.cashbreakdown; 
		depositSlipEm.find( [objid: o.depositslipid ]).update( u );

		def c = depositSlipEm.find( [objid: o.depositslipid ]).first();
		depositSlipEm.updateFundCashTotals( [ depositvoucherid: c.depositvoucherid , fundid: c.fundid ] );
	}

}
