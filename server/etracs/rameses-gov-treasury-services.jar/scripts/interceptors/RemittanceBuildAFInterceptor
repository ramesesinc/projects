import com.rameses.annotations.*;

class RemittanceBuildAFInterceptor {
	
	@DataContext("af_control")
	def afc_db;

	@DataContext("af_control_detail")
	def afcd_db;

	@DataContext("remittance")
	def rem_db; 

	@DataContext("remittance_af")
	def remaf_db; 


	@After(pattern="RemittanceService.post") 
	public void afterPost( evt ) { 
		def remittanceid = evt.result.objid;
		def rem = rem_db.find([ objid: remittanceid ]).first(); 

		def param = [ remittanceid: remittanceid ]; 
		def details = remaf_db.getBuildAFSerial( param ); 

		remaf_db.getBuildAFNonSerial( param ).each{ o-> 
			def fo = afcd_db.find([ controlid: o.controlid ]).orderBy('indexno desc, refdate desc').first(); 
			if ( !fo ) {
				o.beginstartseries = o.startseries; 
				o.beginendseries = o.endseries;
				o.qtybegin = (o.beginendseries-o.beginstartseries)+1; 
			}
			if ( fo && fo.qtyending > 0 ) {
				o.beginstartseries = fo.endingstartseries; 
				o.beginendseries = fo.endingendseries; 
				o.qtybegin = fo.qtyending; 
			}

			if ( o.beginstartseries ) {
				o.issuedstartseries = o.beginstartseries; 
				o.issuedendseries = (o.issuedstartseries + o.qtyissued)-1; 
			}
			if ( o.issuedendseries ) {
				o.endingstartseries = o.issuedendseries+1;
				o.endingendseries = o.endseries; 
			} 

			o.qtyending = o.qtybegin - o.qtyissued; 
			if ( o.qtyending < 0 ) o.qtyending = 0;

			details << o; 
		} 

		param.collectorid = rem.collector.objid; 
		remaf_db.getUnissuedAF( param ).each{ o-> 
			o.qtyreceived = o.qtyissued = o.qtycancelled = 0; 
			o.qtyending = o.qtybegin; 
			if ( details.find{ it.controlid==o.controlid } ) {
				//do nothing, this af control is already in the list 
			} else {
				details << o; 	
			}
		} 

		details.each{ o-> 
			def m = [ objid: o.controlid ]; 
			afc_db.find( m ).update([ lockid: new java.rmi.server.UID().toString() ]); 
			afc_db.syncCurrentIndexNo( m ); 

			def a = afc_db.find( m ).first(); 
			o.indexno = (a.currentindexno ? a.currentindexno : 0) + 1; 			
			afc_db.find( m ).update([ currentindexno: o.indexno, lockid: '{NULL}' ]); 

			o.objid = o.controlid +":::"+ remittanceid; 
			o.refno = rem.txnno;
			o.refid = remittanceid; 
			o.reftype = 'remittance'; 
			o.refdate = rem.dtposted;
			o.txndate = rem.dtposted;
			o.txntype = 'REMITTANCE'; 
			o.remarks = o.txntype;
			afcd_db.create( o ); 
		}

		details = afcd_db.getRemittanceAF([ remittanceid: remittanceid ]); 
		details.each{ o-> 
			if ( o.receivedstartseries ) {
				o.qtyreceived = (o.receivedendseries-o.receivedstartseries)+1;
			}
			if ( o.issuedendseries ) {
				o.endingstartseries = o.issuedendseries + 1;
				o.endingendseries = o.endseries; 
				if ( o.issuedendseries >= o.endseries ) {
					o.endingstartseries = o.endingendseries = null; 
				} 
			} 
			else if ( o.beginstartseries ) {
				o.endingstartseries = o.beginstartseries; 
				o.endingendseries = o.beginendseries; 
			}
			else if ( o.receivedstartseries ) {
				o.endingstartseries = o.receivedstartseries; 
				o.endingendseries = o.receivedendseries; 	
			} 

			if ( o.endingstartseries ) {
				o.qtyending = (o.endingendseries-o.endingstartseries)+1;	
			} else {
				o.qtyending = 0; 
			}

			o.objid = 'REMAF'+ new java.rmi.server.UID(); 
			o.remittanceid = remittanceid; 	
			o.qtycancelled = 0;		
			remaf_db.create( o );  
		} 
	} 
} 