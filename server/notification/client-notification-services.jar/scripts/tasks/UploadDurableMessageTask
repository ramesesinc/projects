
import com.rameses.annotations.*;
import com.rameses.http.*;
import com.rameses.util.*;
import java.io.PrintWriter;
import java.io.StringWriter;

class UploadDurableMessageTask 
{	
    @ActiveDB(value='cloud_notification', em='notification')
    def em;

	@Service('DateService')
	def dateSvc;   

	@Service('CloudNotificationService')
	def notificationSvc;	

	@Service('CloudNotificationUploadService')
	def uploadSvc;	

	//@Schedule(interval=2)
	public void startUpload( task ) {
		def rundate = dateSvc.serverDate;
		def list = em.getPendingDurableMessages([ _start:0, _limit:5, _pagingKeys:'p.objid' ]); 
		while (!list.isEmpty()) {
			def data = list.remove(0); 
			data.rundate = rundate; 
			try { 
				uploadSvc.upload( data ); 
			} catch(Throwable t) { 
				println '[UploadDurableMessageTask] failed to upload pending message caused by ' + t.class.name + ': ' + t.message; 
				processError(t, data); 
				break; 
			} 
		} 
	} 

	private void processError( exception, data ) {
		try {
			if ( !exception ) return; 

			def buffer = new StringWriter();
			exception.printStackTrace(new PrintWriter(buffer)); 
			notificationSvc.markAsFailed([ 
				type         : 'HEADER', 
				objid 		 : data.objid, 
				errormessage : buffer.toString()  
			]); 
		} catch( Throwable t ) { 
			t.printStackTrace(); 
		} 
	} 
}