import com.rameses.annotations.*;
import com.rameses.rules.common.*;
import vehicle.facts.*;
import treasury.utils.*;
import treasury.facts.*;
import com.rameses.annotations.*;
import com.rameses.util.*;
import java.rmi.server.*;
import java.util.*;

class VehicleApplicationService {
	
	@Env
	def env;

	@DataContext("vehicle_application")
	def appEm;

	@DataContext(dynamic=true)
	def em;

	@DataContext("vehicle_account")
	def acctEm;

	@DataContext("vehicle_txntype")
	def txnTypeEm;

	@DataContext("vehicle_control")
	def controlEm;


	@Service("DateService")
	def dateSvc;

	@Service("SchemaService")
	def schemaSvc;

	@ProxyMethod
	public def post( def o ) {
		def z = em.lookup( 'vehicle_account_'+ o.txntype );

		def sc = schemaSvc.getSchema( [name:'vehicle_application'] );
		String exclude = sc.fields*.name.join("|");

		def m = [:];
		//flatten out the infos
		o.each { k,v->
			if(!k.matches(exclude)) {
				m.put(k, v);
			}
		}
		m.activeyear = o.appyear;
		m.state = 'ACTIVE';
		m.acctno = o.appno;
		m.createdby = [objid: env.USERID, name: env.FULLNAME];
		m.dtregistered = dateSvc.getServerDate();
		m.particulars = o.particulars;
		m.txntype = o.txntype;
		m.expirydate = o.expirydate;
		m = z.create(m);
		appEm.find( [objid: o.objid]).update([state:'CLOSED', acctid: m.objid]);

		controlEm.find( [objid: m.control.objid] ).update( [currentacctid: m.objid] );
		return m;
	}

	@ProxyMethod
	public def loadForApplication( def o ) {
		if(!o.txntype)
			throw new Exception("Please indicate txntype");
		if(!o.objid)
			throw new Exception("Please indicate objid");

		def acct = em.lookup( 'vehicle_account_'+ o.txntype ).find( [objid: o.objid]).first();
		def sc = schemaSvc.getSchema( [name:'vehicle_application'] );
		String exclude = sc.fields*.name.join("|");

		def m = [:];
		m.acctid = acct.objid;
		m.owner = acct.owner;
		m.appyear = acct.activeyear + 1;
		acct.each { k,v->
			if(!k.matches(exclude)) {
				m.put(k, v);
			}
		}
		return m;	
	}


}