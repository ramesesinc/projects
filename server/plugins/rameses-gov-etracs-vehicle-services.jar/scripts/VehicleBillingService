import com.rameses.annotations.*;

import com.rameses.rules.common.*;
import vehicle.facts.*;
import treasury.facts.*;
import treasury.utils.*;
import enterprise.facts.*;
import enterprise.utils.*;


/**********************************************************
* This service handles computation of what fees to charge 
***********************************************************/
class VehicleBillingService {
	
	@Service("DateService")
	def dateSvc;

	@DataContext("vehicle_application")
	def appEm;

	@Service("AssessmentRuleService")
	def assmtSvc;

	@ProxyMethod
	public def getBilling( def o ) {
		//find application or vehicleid
		def vehicleid = null;
		def appid = null;
		if(o.appno) {
			def v = appEm.find( [appno: o.appno] ).first();
			appid = v.appid;
		}
		else if( o.appid ) {
			appEm.find( [appno: o.appno] ).first();
		}
	}

	/*
			if(!app.billitems) {
			throw new Exception("VehicleBillingService requires billitems");
		}
		if(!app.apptype) throw new Exception("app type is required");
		if(!app.vehicletype) throw new Exception("vehicle type is required");	
		if(!app.franchise?.controlno) throw new Exception("franchise controlno  is required");	
		def fb = new FactBuilder();
		fb.facts << new VehicleApplication( app );
		fb.facts << new VehicleFranchise( app.franchise );
		fb.facts << new AppDate( app.appdate );
		fb.facts << new treasury.facts.SystemDate(svrDate);
		fb.facts << new treasury.facts.BillDate(app.billdate);
		if(app.payment?.amount) {
			fb.facts << new treasury.facts.Payment( amount: app.payment.amount );
		}
		def svrDate = dateSvc.getServerDate();
		if(!app.billdate) app.billdate = svrDate;
			
	*/

	//This assumes you have already sent the BillItem facts inside
	@ProxyMethod
	public def execute( def facts ) {
		if(! facts.findAll{ it instanceof BillItem } ) 
			throw new Exception("There are no billitems computed. Please review the rules");


		def fb = new FactBuilder();
		fb.facts.addAll( facts );

		if( !facts.find{ it instanceof BillDate }  ) {
			facts << new BillDate( dateSvc.getServerDate() );	
		}

		def r = [ billitems:[] ];

		def rh = [
			getFactKeyValue: { f->
				if( f instanceof DueDate ) {
					r.duedate = f.date;
				}
				else if( f instanceof BillSubItem ) {
					def sv = r.billitems.find{ it.item.objid == f.account.objid };
					if( sv ) {
						sv.amount += f.amount;
						sv.balance += f.amount;
					}
					else {
						r.billitems << f.toMap();
					}
				}
				else if( f instanceof BillItem ) {
					def sv = r.billitems.find{ it.item.objid == f.account.objid };
					if(!sv) {
						r.billitems << f.toMap();	
					}
				}
			}
		] as ResultHandler;

		assmtSvc.execute( "vehiclebilling", null, fb, rh );
		r.amount = r.billitems.sum{ it.amount }
		return r;
	}


}