import com.rameses.annotations.*;

import com.rameses.rules.common.*;
import rules.vehicle.facts.*;
import rules.treasury.facts.*;


/**********************************************************
* This service handles computation of what fees to charge 
***********************************************************/
class VehicleBillingService {
	
	@Service("RuleExecutorService")
	def ruleSvc;

	@Service("DateService")
	def dateSvc;

	@DataContext("vehicle_application")
	def appEm;


	@ProxyMethod
	public def getBilling( def o ) {
		//find application or vehicleid
		def vehicleid = null;
		def appid = null;
		if(o.appno) {
			def v = appEm.find( [appno: o.appno] ).first();
			appid = v.appid;
		}
		else if( o.appid ) {
			appEm.find( [appno: o.appno] ).first();
		}

	}

	@ProxyMethod
	public def process( def o ) {
		if(!o.billitems) {
			throw new Exception("VehicleBillingService requires billitems");
		}
		if(!o.application)
			throw new Exception("VehicleBillingService requires application passed");

		def svrDate = dateSvc.getServerDate();
		if(!o.billdate) o.billdate = svrDate;
		if(!o.dtfiled) o.dtfiled = svrDate;

		def dt = dateSvc.getServerDate();
		def facts = [];
		def app = o.application;
		facts << new VehicleApplication( apptype: app.apptype, vehicletype: app.vehicletype );

		if(o.payment?.amount) {
			facts << new Payment( amount: o.payment.amount );
		}	
		
		facts << new CurrentDate(dt);
		facts << new AppDate( o.dtfiled );
		facts << new rules.treasury.facts.BillDate(o.billdate);
		facts << new rules.treasury.facts.SystemDate(svrDate);

		def  acctUtil = new ItemAccountUtil();
		def billItems = [];
		o.billitems.each {
			def bi = new BillItem( account: acctUtil.createAccountFact(it.item), 
				amount: it.amount, 
				refid: it.objid, 
				ledgertype:it.ledgertype,
				principal: it.principal,
				amtpaid: it.amtpaid
			);
			facts << bi;
			billItems << bi;
		};

		def ctx = new RuleExecutionContext(facts);
		ctx.env.acctUtil = acctUtil;
		ctx.result.billitems = billItems;
		def res = ruleSvc.execute( "vehiclebilling", facts, null, null );
		return res;
	}

}