import com.rameses.annotations.*;
import java.rmi.server.UID;
import rules.enterprise.facts.*;

class VehicleApplicationWorkflowInterceptor {
	

	@DataContext("vehicle_franchise")
	def franchiseEm;

	@DataContext("vehicle_application")
	def appEm;

	@DataContext("vehicle_application_fee")
	def appFeeEm;

	@DataContext("vehicle_application_info")
	def appInfoEm;

	@DataContext("vehicle_payment")
	def appPaymentEm;

	@After(pattern="PersistenceService.read", eval="#{args[0]._schemaname.startsWith('vehicle_application_') }" )
	public void afterOpen(def evt) {
		def entity = evt.result;
		entity.fees = appFeeEm.find([appid: entity.objid]).list();
		entity.amount = 0;
        if(entity.fees) {
            entity.amount = entity.fees.sum{ it.amount - it.amtpaid };
        };
        def vi = new VariableInfoUtil();
        entity.infos = appInfoEm.find( [appid: entity.objid]).orderBy( "sortorder" ).list();
        entity.infos.each {
        	vi.convertData( it );
        };
		entity.payments = appPaymentEm.find( [appid: entity.objid] ).orderBy("refdate DESC").list();
	}	


	@After(pattern="WorkflowTaskService.signal", 
		eval="#{args[0].processname.startsWith('vehicle_application_') && args[0].action == 'release' }" )
	public void beforeRelease(def evt) {
		def o = evt.args[0];
		def app = appEm.find([objid: o.refid]).first();
		if(!app) {
			throw new Exception("Cannot Release. Application not found with refid " + o.refid);
		}
		def d = [:];
		if( app.apptype == 'DROP' ) {
			d.state = 'OPEN';
			d.dtregistered = dateSvc.getServerDate();
			d.appid = null;
		} 
		else {
			d.state = 'ACTIVE'; 
		}
		franchiseEm.find( [objid: app.controlid] ).update( d );
	}	
	

}