import com.rameses.annotations.*;
import java.rmi.server.UID;
import com.rameses.util.*;
import enterprise.utils.*;
import java.rmi.server.*;
import java.util.*;
import vehicle.facts.*;

class VehicleAssessmentInterceptor {

	@DataContext("vehicle_application_fee")
	def appFeeEm;

	@DataContext("vehicle_application_info")
	def appInfoEm;

	@DataContext("vehicle_application")
	def appEm;

	@After(pattern="BillingRuleService.execute", eval="#{ args[0].rulename == 'vehicleassessment' && result.askinfos == null }")
	public void afterBilling(def evt) {
		def result = evt.result;

		def data = evt.args[0].params;
		def app = data.application
		def appid = app.objid;
		def expirydate = result.expirydate;

		//clear first the data before saving
		if( app.apptype == 'LATE_RENEWAL' ) {
			//remove existing fees
			appFeeEm.find( [parentid: appid, appyear: app.appyear ] ).delete(); 

			//remove existing infos if appyear = last renewed
			if( app.appyear == (app.lastrenewal +1) ) {
				//update the total assessment
				appInfoEm.find( [parentid: appid ] ).delete(); 
				result.infos?.each {
					it.parent = [objid: appid ];
					appInfoEm.create( it );
				}
			}
		}
		else {
			//remove existing fees	
			appFeeEm.find( [parentid: appid ] ).delete(); 
			//remove existing infos
			appInfoEm.find( [parentid: appid ] ).delete(); 
			result.infos?.each {
				it.parent = [objid: appid ];
				appInfoEm.create( it );
			}
		}

		//SAVE THE APP FEE HERE.
		result.items?.each {
			it.parent = [objid: appid ];
			it.appyear = app.appyear;
			appFeeEm.create( it );
		}
		appEm.find( [objid: appid ]).update( [expirydate: expirydate]);
	}
	

}	