import com.rameses.annotations.*;
import java.rmi.server.UID;

class VehicleCashReceiptInterceptor {
	
	@Service("VehiclePaymentService")
	def pmtSvc;

	@DataContext("vehicle_application")
	def app;

	@DataContext("vehicle_application_fee")
	def appFee;

	@DataContext("revenueitem")
	def revItem;

	@After(pattern="CashReceiptBarcodeService.findPrefix")
	public void findBarcodePrefix(def evt) {
		def result = evt.result;
		def a = evt.args[0];
		//search the database 
		def z = app.find( [appno: a.barcodeid ] ).exists();
		if(z) {
			result.prefix = '51010';
		}
	}	


	@After(pattern="CashReceiptService.post", eval="#{args[0].collectiontype?.handler == 'vehicle'}")
	public void postPayment(def evt) {
		def r = evt.args[0];
		def t = evt.result;
		def m = [:];
		m.appid = r.appid;
		m.refno = r.receiptno;		
		m.refid = r.objid;		
		m.reftype = "cashreceipt";		
		m.refdate = r.receiptdate;
		m.txndate = t.txndate;
		m.amount = r.amount;
		m.txnmode = 'ONLINE';
		m.voided = 0;
		m.items = r.items;
		m.items.each {
			it.parent = m;
		}
		pmtSvc.postPayment( m );
	}

	@After(pattern="CashReceiptVoidService.post",index=0,eval="#{result.receipt.collectiontype.handler=='vehicle'}")
	public void voidPayment(def evt) {
		def r = evt.args[0].receipt;
		pmtSvc.postVoid( [objid: r.objid]); 
	}

}