import com.rameses.annotations.*;
import treasury.facts.*;

class WaterworksBatchBillingPersistenceInterceptor {
	
	@DataContext("waterworks_billing_batch")
	def batchEm;

	@DataContext("waterworks_billing")
	def wbillEm;

	@Before(pattern="PersistenceService.create", eval="#{ args[0]._schemaname == 'waterworks_billing_batch' }")
	public void beforeCreate( evt ) { 
		def o = evt.args[0];
		o.objid = 'WBILL' + o.zone.code + o.year + o.month.toString().padLeft(2, '0' );
		o.state = 'DRAFT';
	}

	@After(pattern="PersistenceService.create", eval="#{ args[0]._schemaname == 'waterworks_billing_batch' }")
	public void buildBillItems( evt ) { 
		def o = evt.args[0];
		def m = [ batchid: o.objid ];
		batchEm.buildBillings( m );
		batchEm.updateUnpaidAccounts( m ); 		
	}

	@Before(pattern="PersistenceService.removeEntity", eval="#{ args[0]._schemaname == 'waterworks_billing_batch' }")
	public void beforeRemoveEntity( evt ) { 
		def o = evt.args[0];
		batchEm.removeBilling([ batchid: o.objid ]); 
	}
}
