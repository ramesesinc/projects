import com.rameses.annotations.*;

import java.rmi.server.UID;
import com.rameses.util.*;
import treasury.utils.*;
import treasury.facts.*;
import waterworks.facts.*;
import com.rameses.annotations.*;
import com.rameses.util.*;

class WaterworksSingleBillingInterceptor {
	
	@Service('DateService')
	def dateSvc; 

	@DataContext('waterworks_account')
	def acctEm; 

	@DataContext('waterworks_payment')
	def waterPmt; 

	@DataContext("waterworks_consumption")
	def wcEm;

    @After(pattern="SingleBillingService.getInfo",  eval="#{ args[0].rulename == 'waterworksbilling' }" )
	public void getInfo(def evt) {
		def obj = evt.args[0];
		def r = evt.result;
		def p = obj.params;
		def acct = null;
		if( p.objid ) {
			acct = acctEm.find([objid:p.objid]).first();
		}
		else if( p.id ) {
			acct = acctEm.find([acctno:p.id]).first();
		}
		if(!acct) throw new Exception("Waterworks Account not found");
		r.putAll( acct );
		r.acctid = acct.objid;
	}
 
    @After(pattern="SingleBillingService.getBillItems",  eval="#{ args[0].rulename == 'waterworksbilling' }" )
	public void getWaterworksBillItems(def evt) {
		def p = evt.args[0];
		def list = evt.result;

		def arr = [];
		def wp = [:];
		if(p.params.payoption) {
			arr << "((billingcycle.year * 12)+billingcycle.month) <= :yearmonth";
			wp.yearmonth = (p.params.payoption.year * 12)+p.params.payoption.month;
		} 
		arr << "amount - amtpaid > 0"
			
		def select = "year:{billingcycle.year},month:{billingcycle.month},volume,amount,amtdue:{amount-amtpaid},duedate:{billingcycle.duedate},disconnectiondate:{billingcycle.disconnectiondate},refid:{objid},reftype:{'waterworks_consumption'}"; 
		def conList = wcEm.find([acctid: p.acctid]).select(select).where(arr.join(" AND "), wp).list();
		list.addAll( conList );
	}

	@After(pattern="FactBuilderService.getFacts",  eval="#{ args[0] == 'waterworksbilling' }")
	public void buildFactsForBilling(def evt) {
		def data = evt.args[1];
		def factBuilder = evt.result;
		factBuilder.billItemProvider.createBillItemFact = { o-> 
			if( o.reftype == 'waterworks_consumption' ) {
				return new WaterBillItem(o);
			}
			else {
				return new MonthBillItem(o);
			}
		};
		factBuilder.addBillItems( data.billitems ); 
	}

	@After(pattern="SingleBillingService.execute",  eval="#{ args[0].rulename == 'waterworksbilling' }" )
	public void afterBilling(def evt) {
		def r = evt.result;
		/*
		if( m.consumption ) {
			m.chartdata = m.consumption.collect{ [month:it.month, consumption:it.consumption] }
			m.averageconsumption = (int) (m.consumption.sum{it.consumption} / m.consumption.size());
		}
		else {
			m.chartdata = [];
			m.averageconsumption = 0;
		}
		r.billitems.each {
			it.parent = app;
		}		
		*/
	}

	/*******************************************
    * CASH RECEIPT SPECFIC HANDLERS
	********************************************/
	//applicable for cash receipt billing
	@After( pattern="BillingPaymentHandler.formatReceiptInfo", eval="#{  args[0].collectiontype.handler == 'waterworks'  }")
	public void formatCashReceipt(def evt ) {
		def info = evt.args[0].params;
		def res = evt.result;
		if(info.owner?.objid) {
			res.payer = info.owner;
		}
		res.paidby = info.acctname + " (" + info.acctno + ")";
		res.paidbyaddress = info.address?.text;
		res.acctno = info.acctno;
		res.acctid = info.objid;
	} 

	/***********************************************************
    * THIS IS BOTH USED BY CASH RECEIPT AND CAPTURE PAYMENT
	************************************************************/
	@After( pattern="BillingPaymentHandler.getPostPaymentInfo", eval="#{  args[0].collectiontype.handler == 'waterworks'  }")
	public void getPostPaymentInfo(def evt ) {
		def e = evt.args[0];
		def result = evt.result;
		result._schemaname = 'waterworks_payment';
		result.acctid =  e.acctid;
		result.items = e.billitems;
	} 

	@After( pattern="BillingPaymentHandler.getPaymentWorkflow", eval="#{  args[0].collectiontype.handler == 'waterworks'  }")
	public void getWorkflowTask(def evt ) {
		def p = evt.args[0];
		def result = evt.result;
		if(p.taskid) {
			result.processname = 'waterworks_application';
			result.refid = p.txnid; 
			result.taskid = p.taskid;
			result.taskstate = 'payment';
		}
	} 

	@After( pattern="BillingPaymentHandler.getVoidPaymentInfo", eval="#{  args[0].collectiontype.handler == 'waterworks' }")
	public void getVoidPaymentInfo(def evt ) {
		def result = evt.result;
		result._schemaname = 'waterworks_payment';
	} 

	@After( pattern="BillingPaymentHandler.getVoidPaymentWorkflow", eval="#{  args[0].collectiontype.handler == 'waterworks' }")
	public void getVoidWorkflowTask(def evt ) {
		def p = evt.args[0];
		def result = evt.result;
		/*
		result.processname = 'waterworks_application';
		result.refid = p.appid;
		result.taskid = p.taskid;
		result.action = 'return';
		*/
	} 

}