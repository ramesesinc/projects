import com.rameses.annotations.*;

class JobSearchService 
{
	@DataContext("entityindividual")
	def entity;

	@DataContext("entity_education")
	def education;

	@DataContext("entity_eligibility")
	def eligibility;

	@DataContext("entity_jobpreference_occupation")
	def occupation;

	@DataContext("entity_jobpreference_worklocation")
	def worklocation;

	@DataContext("entity_languageproficiency")
	def language;

	@DataContext("entity_skill")
	def skill;

	@DataContext("entity_training")
	def training;

	@DataContext("entity_workexperience")
	def workexperience;

	@ProxyMethod
	def search(searchtext){
		def list = [];
		def templist = [];

		templist += searchByFirstName(searchtext);
		templist += searchBySkill(searchtext);
		templist += searchByWorkExperience(searchtext);

		templist.each{
			def tmprecord = it;
			def found = false;
			list.each{
				def record = it;
				if(record.objid == tmprecord.objid) found = true;
			}
			if(!found) list << tmprecord;
		}
		return list;
	}

	def searchByFirstName(searchtext){
		if(!searchtext) searchtext = "";
		searchtext = '%' + searchtext + '%';
		def list = [];
		def ids = [];

		//def names = entity.find(['firstname':searchtext]).list();
		def names = entity.where("firstname LIKE '" + searchtext + "'").list();
		names.each{
			if(!ids.contains(it.objid)) ids << it.objid;
		}

		ids.each{
			def id = it;
			def record = entity.find(['objid':id]).first();
			if(record) list << record; 
		}
		return list;
	}

	def searchBySkill(searchtext){
		if(!searchtext) searchtext = "";
		searchtext = '%' + searchtext + '%';
		def list = [];
		def ids = [];

		//def skills = skill.find(['name':searchtext]).list();
		def skills = skill.where("name LIKE '" + searchtext + "'").list();
		skills.each{
			if(!ids.contains(it.entityid)) ids << it.entityid;
		}

		ids.each{
			def id = it;
			def record = entity.find(['objid':id]).first();
			if(record) list << record; 
		}
		return list;
	}

	def searchByWorkExperience(searchtext){
		if(!searchtext) searchtext = "";
		searchtext = '%' + searchtext + '%';
		def list = [];
		def ids = [];

		//def experiences = workexperience.find(['position':searchtext]).list();
		def experiences = workexperience.where("position LIKE '" + searchtext + "'").list();
		experiences.each{
			if(!ids.contains(it.entityid)) ids << it.entityid;
		}

		ids.each{
			def id = it;
			def record = entity.find(['objid':id]).first();
			if(record) list << record; 
		}
		return list;
	}

	@ProxyMethod
	def getProfile(id){
		def profile = entity.find(['objid':id]).first();
		profile.jobpreferenceoccupation = occupation.find(['entityid':id]).list();
		profile.jobpreferencelocation = worklocation.find(['entityid':id]).list();
		profile.language = language.find(['entityid':id]).list();
		profile.education = education.find(['entityid':id]).list();
		profile.eligibility = eligibility.find(['entityid':id]).list();
		profile.experience = workexperience.find(['entityid':id]).list();
		profile.training = training.find(['entityid':id]).list();
		profile.skill = skill.find(['entityid':id]).list();
		return profile;
	}
}