import com.rameses.annotations.*;

class OVSCashReceiptService {

    @DataContext("ovs_violation_ticket_entry")
    def entries;

    @DataContext("itemaccount")
    def itemaccount;

    @ProxyMethod
    public def getUnpaidViolations(def o){
        entries.debug = true;
        entries.select("objid,violation.title,amount,amtpaid,violationcount,balance:{amount-amtpaid}, account.objid");
        def list = entries.where("parent.violator_objid = :x AND amount - amtpaid > 0",[x:o.objid]).list();
        if(!list) throw new Exception("There are no unpaid violations for this payer.");
        def m = [:];
        m.items = [];

        list.each{
            def a = [:];
            a.item = itemaccount.find([objid:it.account.objid]).first();
            a.amount = it.balance;
            a.remarks = it.violationcount;
            m.items << a;
        }
        
        m.billitems = list;
        return m;
    }

}