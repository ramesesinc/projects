import com.rameses.annotations.*;

class OVSCashReceiptService {

    @DataContext("ovs_violation_ticket_entry")
    def entries;

    @DataContext("itemaccount")
    def itemaccount;

    @ProxyMethod
    public def getUnpaidViolations(def o){
        entries.select("objid,parent.objid,parent.ticketno,violation.title,violationcount,balance:{amount-amtpaid}, account.objid");
        def list = entries.find(["parent.violator.objid":o.objid]).where("amount - amtpaid > 0").orderBy("parent.dtcreated").list();
        if(!list) throw new Exception("There are no unpaid violations for this payer.");

        list.each{
            it.item = itemaccount.find([objid:it.account.objid]).first();
            it.amount = 0;
        }
        return list;
    }

}