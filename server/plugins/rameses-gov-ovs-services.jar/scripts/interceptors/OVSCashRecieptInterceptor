import com.rameses.annotations.*;
import java.rmi.server.UID;

class OVSCashReceiptInterceptor{

	@DataContext("ovs_payment")
	def p;

	@DataContext("ovs_payment_item")
	def pi;

	@DataContext("ovs_violation_ticket_entry")
	def vte;

	@DataContext("ovs_violation_ticket")
	def vt;

	@After(pattern="CashReceiptService.post", eval="#{result.collectiontype?.handler == 'ovs'}")
	public void postPayment(def evt) {
		def o = evt.args[0];
		def pmt = [:];
		pmt.reftype = "cashreceipt";
		pmt.refid = o.objid;
		pmt.refno = o.receiptno;
		pmt.refdate = o.receiptdate;
		pmt.amount = o.amount;
		pmt.voided = 0;
		pmt.items = [];
		
		def set = new HashSet();
		o.billitems.each {
			set.add(it.parent.objid);
			def pi = [:];
			pi.refid = it.objid;
			pi.amount = it.balance;
			pmt.items << pi;
			vte.debug = true;
			vte.find([objid:it.objid]).update([amtpaid: "{amtpaid + :amt}"],[amt:pi.amount]);
		}

		p.create(pmt);
		def gl = vte.select("parent.objid,xtotal:{SUM(amount - amtpaid)}").find(["parent.violator.objid":o.payer.objid]).where("state = 'OPEN'").groupBy("parent.objid").list();
		gl.each{
			println it;
			if(it.xtotal == 0) {
				vt.find([objid:it.parent.objid]).update([state:'CLOSED']);
			}
		}
	}

	@After(pattern="CashReceiptVoidService.post",index=0,eval="#{result.receipt.collectiontype.handler=='ovs'}")
	public void voidPayment(def evt) {
		def rct = evt.result.receipt;

		p.find( [refid: rct.objid ] ).update( [voided:1]);
		def set = new HashSet();
		def items = pi.where( "parent.refid = :r", [r: rct.objid] ).list();
		items.each {
			vte.debug = true;
			vte.find([objid:it.refid]).update([amtpaid: "{amtpaid - :amt}"],[amt: it.amount]);
		}
		def gl = vte.select("parent.objid,xtotal:{SUM(amount - amtpaid)}").find(["parent.violator.objid":rct.payer.objid]).where("state = 'CLOSED'").groupBy("parent.objid").list();
		gl.each{
			if(it.xtotal > 0) {
				vt.find([objid:it.parent.objid]).update([state:'OPEN']);
			}
		}
	}

}