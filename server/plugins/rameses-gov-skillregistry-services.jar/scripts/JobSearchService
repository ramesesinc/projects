import com.rameses.annotations.*;
import java.util.*;

class JobSearchService 
{

	@Service("DateService")
	def dtSvc;

	@DataContext("entityindividual")
	def entity;

	@DataContext("entity_education")
	def education;

	@DataContext("entity_eligibility")
	def eligibility;

	@DataContext("entity_jobpreference_occupation")
	def occupation;

	@DataContext("entity_jobpreference_worklocation")
	def worklocation;

	@DataContext("entity_languageproficiency")
	def languagepro;

	@DataContext("entity_skill")
	def skill;

	@DataContext("entity_training")
	def training;

	@DataContext("entity_workexperience")
	def workexperience;

	@DataContext("educationallevel")
	def educationallevel;

	@DataContext("language")
	def language;

	@DataContext("address_local")
	def local;

	@DataContext("address_abroad")
	def abroad;

	@ActiveDB("nsrp_entity")
	def em1;

	@ActiveDB(value="nsrp_skill", em="skill")
	def em2;

	@ProxyMethod
	def search(searchtext){
		searchtext = searchtext ? "%" + searchtext + "%" : "%";
		def entityids = "('" + em2.getEntitySearchResultID(['searchtext':searchtext]).collect{it.entityid}.join("','") + "')";
		def data = [];
		def list = em1.getSearchResult(['entityids':entityids,'searchtext':searchtext]);
		list.each{
			data << getProfile(it.objid);
		}
		return data;
	}

	@ProxyMethod
	public def saveProfile( data ) {
		println 'profile ' + data;
	}

	@ProxyMethod
	def advanceSearch(criteria){
		criteria.searchtext = criteria.searchtext ? "%" + criteria.searchtext + "%" : "%";
		def entityids = "('" + em2.getEntitySearchResultID(['searchtext':criteria.searchtext]).collect{it.entityid}.join("','") + "')";
		return em1.getSearchResult(criteria);
	}

	@ProxyMethod
	def getProfile(id){
		def profile = entity.find(['objid':id]).first();
		profile.age = dtSvc.calculateAge(profile.birthdate);
		profile.photo = getPhoto(id);
		profile.jobpreferenceoccupation = occupation.find(['entityid':id]).list();
		profile.jobpreferencelocation = worklocation.find(['entityid':id]).list();
		profile.language = languagepro.find(['entityid':id]).list();
		profile.education = education.find(['entityid':id]).list();
		profile.eligibility = eligibility.find(['entityid':id]).list();
		profile.experience = workexperience.find(['entityid':id]).list();
		profile.training = training.find(['entityid':id]).list();
		profile.skill = skill.find(['entityid':id]).list();
		return profile;
	}

	@ProxyMethod
	def getEducationalLevels(){
		return educationallevel.list();
	}

	@ProxyMethod
	def getLanguages(){
		return language.list();
	}

	@ProxyMethod
	def getLocalAddresses(){
		return local.list();
	}

	@ProxyMethod
	def getNonLocalAddresses(){
		return abroad.list();
	}

	@ProxyMethod
	def getPhoto(id){
		def data = entity.find(['objid':id]).first();
		if(data.photo){
			return new sun.misc.BASE64Encoder().encode(data.photo);	
		}
		return null;
	}
	
}