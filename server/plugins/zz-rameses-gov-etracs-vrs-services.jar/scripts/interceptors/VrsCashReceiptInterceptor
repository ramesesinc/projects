import com.rameses.annotations.*;
import java.rmi.server.UID;

class VrsCashReceiptInterceptor {
	
	@DataContext("vrs_application_fee")
	def af;

	@DataContext("vrs_payment")
	def vp;

	@DataContext("vrs_payment_item")
	def vpi;

	@After(pattern="CashReceiptService.post", eval="#{result.collectiontype?.handler == 'vrs'}")
	public void postPayment(def evt) {
		def o = evt.args[0];
		def pmt = [:];
		pmt.applicationid = o.applicationid;
		pmt.reftype = "cashreceipt";
		pmt.refdate = o.receiptdate;
		pmt.refid = o.objid;
		pmt.refno = o.receiptno;
		pmt.amount = o.amount;
		pmt.voided = 0;
		pmt.items = [];
		vp.create(pmt);

		def ex = af.createExecutor('''
			UPDATE vrs_application_fee 
			SET amtpaid=amtpaid + $P{amount}
			WHERE objid=$P{txnrefid}
		''');

		o.billitems.each {
			def p = [:];
			p.parentid = pmt.objid;
			p.txnrefid = it.refid;
			p.amount = it.amount;
			p.discount = it.discount;
			p.surcharge = it.surcharge;
			p.interest = it.interest;
			vpi.create(p);
			pmt.items << p;
			ex.setParameters( p ).execute();
		}
	}

	@After(pattern="CashReceiptVoidService.post",index=0,eval="#{result.receipt.collectiontype.handler=='vrs'}")
	public void voidPayment(def evt) {
		def rct = evt.result.receipt;

		def pmt = vp.find([refid: rct.objid ]).first();
		println "payment " + pmt;

		def items = vpi.find( [parentid: pmt.objid] ).list();
		println items;
		vp.find( [objid: pmt.objid] ).update([voided:1]);

		def ex = af.createExecutor('''
			UPDATE vrs_application_fee 
			SET amtpaid=amtpaid - $P{amount}
			WHERE objid=$P{txnrefid}
		''');

		items.each {
			def p = [txnrefid: it.txnrefid, amount: it.amount]; 
			ex.setParameters( p ).execute();
		}
	}

}