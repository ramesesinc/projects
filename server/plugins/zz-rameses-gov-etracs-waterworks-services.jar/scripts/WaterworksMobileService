import com.rameses.annotations.*;
import java.rmi.server.*;
import com.rameses.util.*;

class WaterworksMobileService {
	
	@DataContext("waterworks_mobile_info")
	def wm;

	@DataContext("waterworks_account")
	def wa;

	@DataContext("waterworks_account_consumption")
	def wac;

	@Service("DateService")
	def dateSvc;

	@Service("WaterworksBillingService")
	def billingSvc;

	@ProxyMethod
	public def initForDownload( def o ){
		if(!o.assigneeid)	
			throw new Exception("Assignee ID is required!");
		def batchid = 'BTC' + new UID();
		def groupids = "('" + o.groupids.join("','") + "')";
        def y = dateSvc.getServerYear();
		def m = dateSvc.getServerMonth() - 1;
		if(m==0) {
			m = 12;
			y = y-1;
		}

		def duemonth = dateSvc.getServerMonth();
		def dueyear = dateSvc.getServerYear();
		def duedate = new DateBean(dueyear + "-" + duemonth + "-" + 20).getDate();
		def fromdate = new DateBean(y + "-" + m + "-" + 20).getDate();
		def todate = new DateBean(dueyear + "-" + duemonth + "-" + 20).getDate();
		def discodate = new DateBean(dueyear + "-" + duemonth + "-" + 28).getDate();
		def rundate = dateSvc.getServerDate();
		def items = [
			[account: 'Materials', amount:205.50],
			[account: 'Compromise', amount:45.75]
		];

		wm.insertForDownload(
			[
				assigneeid : o.assigneeid,
				groupids   : groupids,
				year       : y, 
				month      : m, 
				batchid    : batchid,
				duemonth   : duemonth,
				dueyear    : dueyear,
				duedate    : duedate,
				fromdate   : fromdate,
				todate     : todate,
				discodate  : discodate,
				rundate    : rundate
			]
		);
		def x = wm.find([batchid:batchid]).list();
		return [batchid:batchid, count: x.size()];
	}

	@ProxyMethod
	public def download( def o ) {
		if(!o.batchid) throw new Exception("Please specify batchid!"); 
		def list = wm.getListForDownload(o);
		list.each {
			it.barcode = '51030:'+it.acctno;

			def sb = new StringBuilder();
			sb.append("[classification:");
			sb.append("\""+it.classificationid+"\"");
			sb.append(",");
			sb.append("metersize:");
			sb.append("\""+it.metersize+"\"");
			sb.append(",");
			sb.append("barangay:");
			sb.append("\""+it.barangay+"\"");
			sb.append("]");
			it.info = sb.toString();
		}
		return list;
	}

	@ProxyMethod
	public def confirmDownload( def o ){
		if(!o.batchid) throw new Exception("Please specify batchid!"); 
		wm.find([batchid:o.batchid]).update([state:"DOWNLOADED"]);
		return "OK";
	}

	@ProxyMethod
	public void cancelDownload( def o ){
		if(!o.batchid) throw new Exception("Please specify batchid!"); 
		def list = "('" + o.downloadedlist.join("','") + "')";
		println 'BATCHID : ' + o.batchid;
		println 'LIST : ' + o.list;
		wm.cancelDownload([batchid: o.batchid, downloadedlist: list]);
	}

	@ProxyMethod
	public def upload( def o ) {
		if(!o.objid) throw new Exception("Please specify objid!");
		if(!o.reading) throw new Exception("Please specify reading!");
		if(!o.dtreading) throw new Exception("Please specify dtreading!");
		if(!o.userid) throw new Exception("Please specify userid!");
		if(!o.name) throw new Exception("Please specify reader_name!");
		if(!o.amount) throw new Exception("Please specify amount!");

		def a = wa.find([objid: o.account.objid]).first();
		if(!a) throw new Exception("Account does not exist!");
		
		o.readingmonth = dateSvc.getServerMonth();
		o.readingyear =  dateSvc.getServerYear();

		def c = [:];
		c.account = o.account;
		c.dtreading = o.dtreading;
		c.year = o.readingyear;
		c.month = o.readingmonth;
		c.prevreading = a.lastreading;
		c.reading = o.reading;
		c.readingmethod = 'ONLINE';
		c.reader = [objid:o.userid, name: o.name]; 
		c.volume = o.reading - a.lastreading;
		c.amount = o.amount;
		c.amtpaid = 0.00;
		wac.create(c);

		def acct = wa.find([objid: o.account.objid]);
		def data = acct.update(
			[
				lastreadingdate : c.dtreading,
				lastreadingmonth : c.month,
				lastreadingyear : c.year,
				lastreading : c.reading,
				prevreading : c.prevreading,
				balance : c.amount
			]
		);

		wm.find([batchid:o.batchid, objid:o.account.objid, state: "DOWNLOADED"]).delete();

		return data;
	}

}