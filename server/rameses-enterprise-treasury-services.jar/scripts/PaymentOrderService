import com.rameses.annotations.*;
import com.rameses.util.*;
import java.rmi.server.*;
import com.rameses.common.*

class PaymentOrderService  {
	
	@DataContext("paymentorder")
	def pmt;
	
	@Service("DateService")
	def dtSvc 

	@DataContext("collectiontype")
	def collectionType;

	@DataContext("revenueitem")
	def revItem;

	@ProxyMethod
	public def create(def entity){	
		if(! entity.payer ) throw new Exception("payer is required. ")
		if(! entity.items ) throw new Exception("items is required. ")
		if(! entity.amount ) throw new Exception("amount is required. ") 
		if(! entity.paidby) throw new Exception("paidby is required. ") 
		if(! entity.paidbyaddress) throw new Exception("paidbyaddress is required. ");
		if(! entity.txntype) throw new Exception("txntype is required. ") 

		if(!entity.collectiontype) {
			entity.collectiontype = collectionType.find([barcodekey:'PMO']).first();
		}	
		if(!entity.collectiontype)
			throw new Exception("Collection type not found!");

		entity.items.each {
			if( !it.item?.objid ) throw new Exception("Items item must have an objid");
			if( !it.amount ) throw new Exception("Items item must have an amount");
			it.item = revItem.find([objid: it.item.objid]).first(); 
		}
		if( entity.items.sum{it.amount} != entity.amount)
			throw new Exception("Amount must be equal sum of amount of items");

		def m = [:];
		m.txnid = KeyGen.generateAlphanumKey( "PMO:", 6 );
		m.expirydate = dtSvc.findNextDate('1y');
		m.info = entity;
		m.payer = entity.payer;
		m.txntype = entity.txntype;
		m.amount = entity.amount;
		pmt.create(m);
		return m; 
	}

	@ProxyMethod
	def open( params) {
		def entity = pmt.find([txnid: 'PMO:'+params.txnid]).first();
		if( !entity || entity.size()==0 ) {
			throw new Exception("Payment Order Code does not exist. ")
		}	
		return entity; 
	}

	@ProxyMethod
	def close( params ){ 
		pmt.find([txnid: params.txnid]).delete();
	}


}