import com.rameses.annotations.*;
import com.rameses.util.*;
import com.rameses.common.*

class PaymentMethodService {

	@DataContext('payment_partner')
	def em;

	@DataContext("eor_paymentorder")
	def eor_paymentorder; 

	@Service('CacheService') 
	def cacheSvc;

	@Service('PaymentOrderService') 
	def payOrderSvc;

	@Env 
	def env 

	@Service 
	def self;

	@ProxyMethod
	public def getPaymentMethods( params ) {
		if ( !params.billid ) throw new Exception('billid is required.')
		
		env.bill = cacheSvc.get([ key: params.billid ]);  
		def result = [];
		result << [ objid: 'CASHIER', caption:'Pay To Cashier', info:[:] ];  
		result.addAll( em.where('1=1').list());
		result.each{ self.loadPartner( it ) }
		return result; 
	} 

	@ProxyMethod 
	public def loadPartner( def o ) { 
		return o; 
	}

	@ProxyMethod 
	public def createPaymentOrder( params ) {
		if ( !params.billid ) throw new Exception('billid is required.'); 
		println 'createPaymentOrder -> ' + params 
		def bill = cacheSvc.get([ key: params.billid ]); 

		def pmo = [:];
		pmo.txnid = bill.txnid; 
		pmo.controlno = bill.controlno; 
		pmo.payer = bill.payer; 
		pmo.paidby = bill.paidby;
		pmo.paidbyaddress = bill.paidbyaddress;
		pmo.particulars = bill.particulars;
		pmo.amount = bill.amount; 
		pmo.expirydate = bill.expirydate;
		pmo.refid = bill.refid;
		pmo.refno = bill.refno; 
		pmo.txntype = bill.txntype;
		pmo.info = (bill.info ? bill.info : [:]); 
		pmo = payOrderSvc.create( pmo );  
		cacheSvc.put([key:pmo.txnid, value:pmo])
	} 

	@ProxyMethod
	public def logForPayment( params ) {
		if (!params.txnid) throw new Exception('txnid is required.')

		def pmo = cache.get([key:params.txnid])
		if (!pmo) throw new Exception('Payment Order cannot be loaded. Please close and repeat the transaction.')

		def eor = eor_paymentorder.find([objid:pmo.txnid]).first()
		if (eor) return eor

		eor = [:]
		eor.objid = pmo.txnid 
		eor.refid = pmo.refid
		eor.refno = pmo.refno 
		eor.dtcreated = dtSvc.serverDate 
		eor.paymentorder = pmo 
		eor_paymentorder.create(eor)
		return eor 
	}
}
