import com.rameses.annotations.*;

import treasury.utils.*;
import treasury.facts.*;
import enterprise.utils.*;
import com.rameses.annotations.*;
import com.rameses.util.*;
import java.rmi.server.*;
import java.util.*;
import com.rameses.rules.common.RuleExecutionContext;

public class BillingReceiptInterceptor {
	
	@Service("PaymentPostingService")
	def service;

	@Service("BillingPaymentHandler")
	def voidHandler;

	@After(pattern="CashReceiptService.post", eval="#{ args[0]._postpayment !=null  }",  index=50)
	public void postPayment(def evt) {
		def e = evt.args[0];
		def result = evt.result;
		def pmt = e._postpayment;

		//format the payment references
		pmt.reftype = "cashreceipt";
		pmt.refno = result.receiptno;
		pmt.refdate = result.receiptdate;
		pmt.refid = result.objid;
		pmt.txndate = result.txndate;

		def wf = e._workflow;
		if( wf ) { pmt._workflow = wf; }
		service.post( pmt );
	}


	@After(pattern="CashReceiptVoidService.post")
	public void voidPayment(def evt) {
		def e = evt.args[0];
		def res= evt.result;

		def rct = res.receipt;
		def pmt = voidHandler.getVoidPaymentInfo( [refid: rct.objid, collectiontype: rct.collectiontype ] );
		if( pmt ) {
			pmt.collectiontype = rct.collectiontype;
			def wf = voidHandler.getVoidPaymentWorkflow( pmt );
			if(wf) { 
				if(!wf.processname) throw new Exception("processname is required in getVoidPaymentInfo.getVoidPaymentWorkflow for " + rct.collectiontype.handler );
				if(!wf.taskid) throw new Exception("taskid is required in getVoidPaymentInfo.getVoidPaymentWorkflow for " + rct.collectiontype.handler );
				if(!wf.action) throw new Exception("action is required in getVoidPaymentInfo.getVoidPaymentWorkflow for " + rct.collectiontype.handler );
				if(!wf.refid ) throw new Exception("refid is required in getVoidPaymentInfo.getVoidPaymentWorkflow for " + rct.collectiontype.handler );
				pmt._workflow = wf; 
			}
			if(!pmt._schemaname) throw new Exception("_schemaname is required in getVoidPaymentInfo for " + rct.collectiontype.handler );
			if(!pmt.objid) throw new Exception("objid is required in getVoidPaymentInfo for " + rct.collectiontype.handler );
			service.reversePayment( pmt );
		}
	}



}